# Supabase Auth 実装ガイド

このガイドに従って、安全なSupabase認証システムを導入してください。

## 🔒 セキュリティの改善内容

- ✅ Row Level Security (RLS) によるデータ保護
- ✅ 各ユーザーは自分のデータのみアクセス可能
- ✅ パスワード認証による安全なログイン
- ✅ 本番環境で公開しても安全

## 📋 実装手順

### 1. Supabaseダッシュボードでの設定

#### 1-1. SQLスクリプトの実行

1. Supabaseダッシュボードにログイン
   - https://supabase.com/dashboard

2. プロジェクトを選択

3. 左メニューから「SQL Editor」を選択

4. `supabase-setup.sql` の内容をコピー&ペーストして実行
   - ⚠️ **注意**: このスクリプトは既存のテーブルを削除して再作成します
   - 既存のデータは失われますので、必要に応じてバックアップしてください

#### 1-2. Email認証の有効化確認

1. 左メニューから「Authentication」→「Providers」を選択

2. 「Email」プロバイダーが有効になっていることを確認
   - 有効になっていない場合は、トグルをONにする

3. 「Confirm email」の設定（推奨設定）：
   - **開発環境**: OFFにすると、メール確認なしでログイン可能
   - **本番環境**: ONにして、メール確認を必須にする

### 2. アプリケーションの確認

すでにコードは更新済みです。以下のファイルが変更されました：

- ✅ `lib/supabase/auth.ts` - 認証関数（新規作成）
- ✅ `lib/supabase/database.ts` - データベース操作を認証対応に更新
- ✅ `app/page.tsx` - UIをログイン/サインアップフォームに変更

### 3. アプリケーションの起動

```bash
npm run dev
```

### 4. 動作確認

#### 4-1. 新規登録

1. http://localhost:3000 にアクセス

2. 「新規登録」ボタンをクリック

3. 以下の情報を入力：
   - 名前: 例）田中太郎
   - メールアドレス: 例）tanaka@example.com
   - パスワード: 6文字以上

4. 「登録してログイン」ボタンをクリック

5. **メール確認が有効な場合**:
   - 受信したメールのリンクをクリックして確認
   - その後、ログインページでログイン

6. **メール確認が無効な場合**:
   - 自動的にログインされます

#### 4-2. タスクの作成

1. ログイン後、タスクを追加してみてください

2. ブラウザのコンソール（F12）を開いて、エラーがないか確認

3. **401エラーが出ないこと**を確認

#### 4-3. ログアウト

1. 右上の「ログアウト」ボタンをクリック

2. ログイン画面に戻ることを確認

#### 4-4. ログイン

1. メールアドレスとパスワードを入力

2. 「ログイン」ボタンをクリック

3. 以前作成したタスクが表示されることを確認

## 🔍 トラブルシューティング

### エラー: "Failed to fetch"

- Supabase URLとAPIキーが正しいか確認
- `.env.local` ファイルが存在するか確認
- 開発サーバーを再起動

### エラー: "Email not confirmed"

- Supabaseダッシュボード > Authentication > Providers
- Email providerの「Confirm email」をOFFにする（開発環境の場合）

### タスクが作成できない（401エラー）

- SQLスクリプトが正しく実行されたか確認
- RLSポリシーが設定されているか確認
- ログインしているユーザーが有効か確認

### ログインできない

- メールアドレスとパスワードが正しいか確認
- パスワードは6文字以上か確認
- Supabaseダッシュボード > Authentication > Users でユーザーが作成されているか確認

## 📚 さらなる改善案

現在の実装で基本的なセキュリティは確保されていますが、以下の機能を追加することもできます：

1. **パスワードリセット機能**
   - ユーザーがパスワードを忘れた場合のリセット機能

2. **プロフィール編集**
   - ユーザー名の変更機能

3. **メール確認の有効化**
   - 本番環境では必ず有効にすることを推奨

4. **ソーシャルログイン**
   - Google、GitHub等でのログイン

5. **2段階認証**
   - より高度なセキュリティ

## 🎉 完了！

これで安全なSupabase認証システムが実装されました。
401エラーは解消され、各ユーザーは自分のデータのみにアクセスできるようになりました。
